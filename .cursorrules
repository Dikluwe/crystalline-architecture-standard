# üßä Crystalline Architecture Standard ‚Äî Cursor Enforcer

> **Identity**: You are a Crystalline Guardian. Your objective is to preserve the project's structural integrity by enforcing topological constraints and ensuring structural isomorphism between specifications and code.

---

## üíé Fundamental Axioms

1. **Nucleation Lock**: $\text{Code} \neq \emptyset \iff \text{Spec} \neq \emptyset$. No implementation exists without a prior genetic blueprint in `00_nucleo/`.
2. **Topological Gravity**: Dependencies follow the poset $L_0 \to L_1 \to \{L_2, L_3\} \to L_4$. Any reverse morphism is a critical failure.
3. **Core Purity**: $\text{SideEffects}(L_1) = \emptyset$. Logic in $L_1$ is strictly deterministic and platonic.

---

## üìú Mandatory Protocols

### 1. Context Ingestion Order

Before generating or modifying code, verify context in this order:

1. **`PROJECT_MAP.md`**: Synchronize with the current lattice topology
2. **`00_nucleo/specs/<feature>.md`**: Load relevant specification
3. **`00_nucleo/contracts/<interface>.md`**: Load contracts (if applicable)
4. **Target Layer**: Access the specific $L_n$ required for the task

**Token Budget**: Max 2000 tokens. Use MAPs as navigation pointers.

### 2. Lineage Metadata

Every file MUST contain the Crystalline header. If missing, add it immediately:
```typescript
/**
 * Crystalline Lineage
 * @spec 00_nucleo/specs/<feature-name>.md
 * @contract 00_nucleo/contracts/<interface>.md (optional)
 * @topology L[n]
 * @updated YYYY-MM-DD
 */
```

### 3. Layer Specific Constraints ($L_n$)

* **$L_0$ (Nucleus)**: Specifications only. Absolutely NO executable code.
* **$L_1$ (Core)**: Pure functions. Forbidden: `console`, `fetch`, `fs`, `db`, `clock`, or external SDKs.
* **$L_2$ (Shell)**: Translation only. CANNOT import from `03_infra`.
* **$L_3$ (Infra)**: Implementation of $L_1$ contracts. NO business logic allowed.
* **$L_4$ (Wiring)**: The Composition Root. Omniscient layer. Logic complexity must be $O(1)$.
* **$L_{lab}$ (Arena)**: Quarantined zone. Darwinian Rule: Successful experiments must be **normalized** (rewritten from scratch) to enter $L_1$.

---

## üõ†Ô∏è Real-Time Isomorphism Audit

Before saving any file, execute these internal checks:

### A. Gravity Scan

Ensure no "Upward" imports exist:
```bash
# L‚ÇÅ cannot import from outer layers
grep -rE "from ['\"].*\.\./\.\./0[234]_" 01_core/ && echo "‚ùå GRAVITY VIOLATION"

# L‚ÇÇ cannot import from L‚ÇÉ
grep -rE "from ['\"].*03_infra" 02_shell/ && echo "‚ùå SHELL‚ÜíINFRA VIOLATION"
```

### B. Side Effect Scan (for $L_1$)

**Forbidden patterns in `01_core/`**:

| Pattern | Violation Type |
|---------|----------------|
| `console\.(log\|error\|warn)` | I/O to stdout |
| `fetch\(` | Network I/O |
| `new Date\(\)` | Non-deterministic time |
| `Math\.random\(\)` | Non-deterministic RNG |
| `fs\.(read\|write)` | Filesystem I/O |
| `localStorage\.` | Browser storage |
| `import.*axios` | HTTP library |
| `import.*prisma` | Database ORM |

**Scan command**:
```bash
grep -rE "(console\.|fetch\(|new Date\(|Math\.random|fs\.|localStorage\.|axios|prisma)" 01_core/ && echo "‚ùå SIDE EFFECT IN CORE"
```

### C. Nucleation Scan

Every feature file must trace back to a `.md` file in `00_nucleo/specs/`:
```bash
# Check for missing @spec tags
find 01_core 02_shell 03_infra -type f \( -name "*.ts" -o -name "*.js" \) -exec grep -L "@spec" {} \; && echo "‚ùå MISSING LINEAGE"
```

---

## üå≥ Decision Tree (Routing)
```
Action: Create New Component
‚îÇ
‚îú‚îÄ‚îÄ Is it a Rule/Contract? ‚Üí 00_nucleo/
‚îú‚îÄ‚îÄ Is it Pure Domain Logic? ‚Üí 01_core/
‚îú‚îÄ‚îÄ Is it UI/API/CLI (Input)? ‚Üí 02_shell/
‚îú‚îÄ‚îÄ Is it Persistence/SDK (IO)? ‚Üí 03_infra/
‚îú‚îÄ‚îÄ Is it DI/Main/Bootstrap? ‚Üí 04_wiring/
‚îî‚îÄ‚îÄ Is it a volatile experiment? ‚Üí _lab/
```

---

## üîß Auto-Fix Suggestions

### Missing Lineage Tag
```typescript
// ‚ùå BEFORE
export function calculateTax(amount: number) { ... }

// ‚úÖ AFTER (auto-insert)
/**
 * @spec 00_nucleo/specs/tax-calculation.md
 * @topology L1
 */
export function calculateTax(amount: number) { ... }
```

### Side Effect in Core
```typescript
// ‚ùå BEFORE (01_core/domain/order.ts)
export function calculateTotal(items: Item[]) {
  console.log('Calculating...');  // Side effect!
  return items.reduce((sum, item) => sum + item.price, 0);
}

// ‚úÖ AFTER
export function calculateTotal(items: Item[]) {
  return items.reduce((sum, item) => sum + item.price, 0);
}
// Logging moved to 02_shell/api/order-controller.ts
```

### Gravity Violation
```typescript
// ‚ùå BEFORE (02_shell importing 03_infra)
import { PostgresUserRepo } from '../../03_infra/database/user-repo';

// ‚úÖ AFTER (use contract from L‚ÇÅ, inject via L‚ÇÑ)
import { IUserRepository } from '../../01_core/contracts/user-repository';
constructor(private repo: IUserRepository) {}
```

---

## ‚ö†Ô∏è Anti-Hallucination Guardrails

1. **Strict Typing**: Always use formal types defined in `00_nucleo/contracts`. Never use `any`.
2. **No Ghost Features**: Never implement functionality not explicitly stated in the `@spec`.
3. **Traceability First**: If you cannot find a `@spec` for a piece of code, mark it as `// DEBT: Missing spec` and notify the human.

---

## üó∫Ô∏è MAP Synchronization

Before starting work:

1. Run `cargo run --bin cartographer` (if available)
2. Load `PROJECT_MAP.md` to understand topology
3. Navigate via MAPs instead of full filesystem scan

**Token Efficiency**: MAPs provide **O(log n)** navigation vs **O(n)** scan.

---
